name: Continous Builds Cli

on:
  push:
    branches: [master]

jobs:
  job_1:
      runs-on: ubuntu-20.04
      steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v2
          with:
            python-version: '3.8'
        - name: install opencv
          run: |
              sudo apt-get update
              sudo apt-get dist-upgrade
              sudo apt-get install mesa-common-dev libgl1-mesa-dev libssl-dev
              sudo apt-get install libxcb-*
              sudo apt-get install libxkb-*
              sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libnss3
              sudo apt-get install libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev
              sudo apt-get install libopencv-dev
        - name: install qt6
          run: |
            pip install aqtinstall
            python3 -m aqt install-qt -m qtwebengine qtwebchannel qtpositioning -O ${{ github.workspace }}/Qt/ linux desktop 6.2.0
            echo ${{ github.workspace }}/Qt/6.2.0/gcc_64/bin/ >> $GITHUB_PATH
        - name: build
          run: |
              ./run.sh cli
              make clean
        - name: appimage
          run: |
              cd build_cli
              wget -O deploy.AppImage https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
              chmod +x deploy.AppImage
              cp ../sh.fasttrack.fasttrackcli.desktop .
              cp ../src/assets/fasttrack.png .
              export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${{ github.workspace }}/Qt/6.2.0/gcc_64/lib/
              ./deploy.AppImage fasttrack-cli -appimage -no-translations -bundle-non-qt-libs -unsupported-allow-new-glibc -qmake=${{ github.workspace }}/Qt/6.2.0/gcc_64/bin/qmake6 -extra-plugins=platforms/
              mv FastTrack*.AppImage FastTrack-cli-x86_64.AppImage
        - name: Linux artefact
          uses: actions/upload-artifact@v1
          with:
            name: FastTrackLinux
            path: ./build_cli/FastTrack-cli-x86_64.AppImage
  job_2:
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v2
          with:
            python-version: '3.8'
        - name: install qt6
          run: |
            pip install aqtinstall
            python3 -m aqt install-qt -m qtwebengine qtwebchannel qtpositioning -O ${{ github.workspace }}/Qt/ mac desktop 6.2.0
            echo ${{ github.workspace }}/Qt/6.2.0/macos/bin/ >> $GITHUB_PATH
        - name: install opencv
          run: |
              rm -rf /usr/local/bin/2to3
              brew update
              brew upgrade
              brew install pkg-config
              brew install opencv
              export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/
        - name: build
          run: |
              qmake src/FastTrack-Cli.pro
              make
              cd build_cli/
              macdeployqt fasttrack-cli.app -always-overwrite
              wget https://raw.githubusercontent.com/arl/macdeployqtfix/master/macdeployqtfix.py
              python2.7 macdeployqtfix.py fasttrack_cli.app/Contents/MacOS/fasttrack-cli ../../Qt/6.2.0/
              hdiutil create -volname fasttrack-cli -srcfolder fasttrack-cli.app -ov -format UDZO fasttrack-cli.dmg


        - name: Mac artefact
          uses: actions/upload-artifact@v1
          with:
            name: FastTrackMac
            path: ./build_cli/fasttrack-cli.dmg
